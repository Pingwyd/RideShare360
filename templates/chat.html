{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card border-0 shadow-lg rounded-3 overflow-hidden" style="height: 80vh;">
            <div class="card-header bg-primary text-white p-3 d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0 fw-bold"><i class="fas fa-comments me-2"></i>Ride Chat</h5>
                    <small class="opacity-75">{{ ride.origin }} <i class="fas fa-arrow-right mx-1"></i> {{ ride.destination }}</small>
                </div>
                <a href="{{ url_for('main.ride_details', ride_id=ride.id) }}" class="btn btn-sm btn-light text-primary fw-bold">
                    <i class="fas fa-info-circle me-1"></i> Details
                </a>
            </div>
            
            <div class="card-body bg-light p-4" id="chat-box" style="overflow-y: auto; display: flex; flex-direction: column;">
                {% for msg in messages %}
                <div class="d-flex flex-column mb-3 {% if msg.sender_id == current_user.id %}align-items-end{% else %}align-items-start{% endif %}">
                    <div class="d-flex align-items-center mb-1">
                        <small class="fw-bold text-secondary me-2">{{ msg.sender_name }}</small>
                        <small class="text-muted" style="font-size: 0.7rem;">{{ msg.timestamp }}</small>
                    </div>
                    <div class="p-3 rounded-3 shadow-sm {% if msg.sender_id == current_user.id %}bg-primary text-white{% else %}bg-white text-dark{% endif %}" style="max-width: 75%;">
                        {{ msg.message }}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="card-footer bg-white p-3 border-top">
                <form id="message-form">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control border-end-0 bg-light" placeholder="Type a message..." required autocomplete="off">
                        <button class="btn btn-primary fw-bold px-4" type="submit">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    var socket = io();
    var rideId = {{ ride.id }};
    var currentUserId = {{ current_user.id }};
    var currentUserName = "{{ current_user.name }}";

    socket.on('connect', function() {
        socket.emit('join', {room: rideId});
    });

    socket.on('status', function(data) {
        var chatBox = document.getElementById('chat-box');
        chatBox.innerHTML += '<div class="text-center text-muted my-2"><small class="badge bg-light text-secondary border">' + data.msg + '</small></div>';
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on('message', function(data) {
        var chatBox = document.getElementById('chat-box');
        var sender = data.sender || 'Unknown';
        var time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Determine if message is from current user
        // Note: In a real app, you'd compare IDs, but for this snippet we'll use name or just style it as incoming if we can't be sure
        var isMe = (sender === currentUserName); 
        
        var alignClass = isMe ? 'align-items-end' : 'align-items-start';
        var bubbleClass = isMe ? 'bg-primary text-white' : 'bg-white text-dark';
        
        var html = `
        <div class="d-flex flex-column mb-3 ${alignClass}">
            <div class="d-flex align-items-center mb-1">
                <small class="fw-bold text-secondary me-2">${sender}</small>
                <small class="text-muted" style="font-size: 0.7rem;">${time}</small>
            </div>
            <div class="p-3 rounded-3 shadow-sm ${bubbleClass}" style="max-width: 75%;">
                ${data.msg}
            </div>
        </div>`;
        
        chatBox.innerHTML += html;
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        var input = document.getElementById('message-input');
        var msg = input.value;
        if (msg) {
            socket.emit('message', {room: rideId, msg: msg});
            input.value = '';
        }
    });
</script>
{% endblock %}